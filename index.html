<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>David 鐵板燒 - 領取 $200 優惠</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        david: {
                            orange: '#EA580C', 
                            brown: '#431407',
                            bg: '#FFF7ED',
                            gold: '#F59E0B'
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'float': '0 10px 15px -3px rgba(234, 88, 12, 0.2)',
                    },
                    animation: {
                        'point-down': 'pointDown 1.5s infinite',
                    },
                    keyframes: {
                        pointDown: {
                            '0%, 100%': { transform: 'translateY(0)', opacity: '0.6' },
                            '50%': { transform: 'translateY(5px)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FFF7ED;
            color: #431407;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* 優惠券樣式 - 鋸齒邊緣 */
        .coupon-notch {
            position: absolute;
            top: 50%;
            width: 24px;
            height: 24px;
            background-color: #FFF7ED;
            border-radius: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }
        .notch-left { left: -12px; }
        .notch-right { right: -12px; }

        .snap-x {
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .snap-center {
            scroll-snap-align: center;
            scroll-snap-stop: always;
        }

        /* Banner 滑動優化 - JS 控制，禁用 CSS snap */
        #bannerSlider {
            scroll-snap-type: none !important;
            overscroll-behavior-x: contain;
        }
        #bannerSlider > * {
            scroll-snap-align: none !important;
        }

        /* 跳轉時隱藏頁面內容 */
        body.redirecting {
            visibility: hidden;
        }
        body.redirecting::before {
            content: '跳轉中...';
            visibility: visible;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #EA580C;
            font-weight: bold;
        }
    </style>

    <script>
        // 快速判斷：如果是從外部跳轉過來，先隱藏頁面
        (function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('session_id') || params.get('ip')) {
                document.documentElement.classList.add('redirecting-flag');
            }
        })();
    </script>
</head>
<body class="pb-32" onload="if(document.documentElement.classList.contains('redirecting-flag'))this.classList.add('redirecting')">

    <!-- 1. 頂部 Logo -->
    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur shadow-sm px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-9 h-9 bg-david-orange rounded-lg flex items-center justify-center text-white text-lg shadow-md">
                <i class="fas fa-utensils"></i>
            </div>
            <div>
                <h1 class="text-lg font-black tracking-wide text-david-brown leading-none">
                    David <span class="text-sm font-bold text-gray-500">鐵板燒</span>
                </h1>
                <p class="text-[10px] text-david-orange font-medium tracking-wider">TAIWANESE TEPPANYAKI</p>
            </div>
        </div>
        <div class="flex items-center gap-1 text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full border border-green-100">
            <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
            營業中
        </div>
    </nav>

    <!-- 2. 滑動美食 Banner -->
    <section class="mt-5 px-4">
        <p class="text-xs font-bold text-gray-400 mb-2 px-1 flex items-center gap-1">
            <i class="fas fa-fire-alt text-david-orange"></i> 師傅現做推薦
        </p>
        
        <div id="bannerSlider" class="flex overflow-x-auto snap-x hide-scroll gap-3 pb-4">
            
            <!-- Slide 1: 師傅煎牛排 -->
            <div class="min-w-[90%] snap-center relative rounded-2xl overflow-hidden shadow-float h-60 group">
                <img src="https://drive.google.com/uc?export=view&id=1owLyAUzXc8a2lEfdz_QFditeE08Pxn_q" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                <div class="absolute bottom-4 left-4 text-white">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-david-orange text-[10px] px-2 py-0.5 rounded font-bold">招牌</span>
                        <span class="text-xs text-orange-200"><i class="fas fa-clock mr-1"></i>現點現煎</span>
                    </div>
                    <h2 class="text-2xl font-black mb-0.5">師傅手切牛排</h2>
                    <p class="text-sm opacity-90 text-gray-300">高溫封鎖肉汁，每一口都鮮嫩</p>
                </div>
            </div>

            <!-- Slide 2: 黃金雞腿排 -->
            <div class="min-w-[90%] snap-center relative rounded-2xl overflow-hidden shadow-float h-60 group">
                <img src="https://drive.google.com/uc?export=view&id=1GRYB8YOu6Ae-CB1GcEa_X2WesNSgAldg" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                <div class="absolute bottom-4 left-4 text-white">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-david-gold text-black text-[10px] px-2 py-0.5 rounded font-bold">人氣</span>
                        <span class="text-xs text-yellow-200"><i class="fas fa-star mr-1"></i>酥脆多汁</span>
                    </div>
                    <h2 class="text-2xl font-black mb-0.5">黃金脆皮雞腿</h2>
                    <p class="text-sm opacity-90 text-gray-300">嚴選大雞腿，慢火煎至外酥內嫩</p>
                </div>
            </div>

            <!-- Slide 3: 明蝦干貝 -->
            <div class="min-w-[90%] snap-center relative rounded-2xl overflow-hidden shadow-float h-60 group">
                <img src="https://drive.google.com/uc?export=view&id=1j2aCsaHhhz_CaQC0RSAcI9AwTm8azKjw" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                <div class="absolute bottom-4 left-4 text-white">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded font-bold">極鮮</span>
                        <span class="text-xs text-blue-200"><i class="fas fa-water mr-1"></i>海陸升級</span>
                    </div>
                    <h2 class="text-2xl font-black mb-0.5">深海明蝦佐干貝</h2>
                    <p class="text-sm opacity-90 text-gray-300">兩尾大蝦搭配鮮甜干貝，極致享受</p>
                </div>
            </div>

        </div>
    </section>

    <!-- 3. 優化後的優惠券：好友限定權益 -->
    <section class="px-4 mb-8">
        <div class="relative w-full bg-gradient-to-r from-red-600 to-red-700 rounded-xl shadow-xl flex items-stretch h-28 overflow-hidden">
            <!-- 裝飾背景 -->
            <div class="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-yellow-300 via-transparent to-transparent"></div>
            
            <!-- 左右缺口 -->
            <div class="coupon-notch notch-left shadow-inner"></div>
            <div class="coupon-notch notch-right shadow-inner"></div>

            <!-- 左側：價值區 -->
            <div class="w-[70%] p-4 flex flex-col justify-center relative border-r-2 border-dashed border-white/20">
                <div class="flex items-center gap-1 mb-1">
                    <span class="bg-yellow-400 text-red-800 text-[10px] font-bold px-1.5 py-0.5 rounded-sm">見面禮</span>
                    <span class="text-[10px] text-white/80">David 鐵板燒</span>
                </div>
                <div class="flex items-baseline gap-1">
                    <span class="text-lg font-bold text-white">$</span>
                    <span class="text-5xl font-black text-white tracking-tighter drop-shadow-sm">200</span>
                </div>
                <p class="text-xs text-white/80">餐點現金抵用券</p>
            </div>

            <!-- 右側：權益說明區 (已修正為好友限定) -->
            <div class="w-[30%] bg-black/10 flex flex-col items-center justify-center text-white relative">
                <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center mb-1">
                    <!-- 皇冠圖示 -->
                    <i class="fas fa-crown text-yellow-300 text-sm"></i>
                </div>
                <!-- 文案優化 -->
                <p class="text-xs font-bold opacity-90">好友限定</p>
                
                <!-- 向下引導箭頭 -->
                <div class="absolute bottom-2 animate-point-down">
                    <i class="fas fa-arrow-down text-[10px] text-white/70"></i>
                </div>
            </div>
        </div>
        
        <!-- 輔助文字 -->
        <p class="text-center text-xs text-gray-500 mt-2 flex items-center justify-center gap-1">
            <i class="fas fa-gift text-david-orange"></i>
            點擊下方按鈕加入好友，<span class="text-gray-700 font-bold">系統自動發送</span>此優惠
        </p>
    </section>

    <!-- 4. 鎖定功能 (Grid Layout) -->
    <section class="px-4 mb-6">
        <div class="flex items-center justify-between mb-3 px-1">
            <h3 class="font-bold text-david-brown text-base">會員專屬服務</h3>
            <span class="text-xs text-gray-400 bg-white px-2 py-0.5 rounded-full border border-gray-100 shadow-sm">
                <i class="fas fa-lock text-[10px] mr-1"></i>加入後解鎖
            </span>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <!-- 訂位 -->
            <div class="bg-white p-3 rounded-xl border border-orange-100 shadow-sm flex items-center gap-3 relative overflow-hidden opacity-80">
                <div class="w-10 h-10 rounded-full bg-orange-50 text-david-orange flex items-center justify-center text-lg shrink-0">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 text-sm">線上訂位</h4>
                    <p class="text-[10px] text-gray-500">免打電話</p>
                </div>
                <i class="fas fa-lock text-gray-300 absolute top-2 right-2 text-[10px]"></i>
            </div>
            
            <!-- 菜單 -->
            <div class="bg-white p-3 rounded-xl border border-orange-100 shadow-sm flex items-center gap-3 relative overflow-hidden opacity-80">
                <div class="w-10 h-10 rounded-full bg-orange-50 text-david-orange flex items-center justify-center text-lg shrink-0">
                    <i class="fas fa-book-open"></i>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 text-sm">瀏覽菜單</h4>
                    <p class="text-[10px] text-gray-500">人氣套餐</p>
                </div>
                <i class="fas fa-lock text-gray-300 absolute top-2 right-2 text-[10px]"></i>
            </div>

            <!-- 外帶 -->
            <div class="bg-white p-3 rounded-xl border border-orange-100 shadow-sm flex items-center gap-3 relative overflow-hidden opacity-80">
                <div class="w-10 h-10 rounded-full bg-orange-50 text-david-orange flex items-center justify-center text-lg shrink-0">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 text-sm">外帶點餐</h4>
                    <p class="text-[10px] text-gray-500">預約取餐</p>
                </div>
                <i class="fas fa-lock text-gray-300 absolute top-2 right-2 text-[10px]"></i>
            </div>

            <!-- 客服 -->
            <div class="bg-white p-3 rounded-xl border border-orange-100 shadow-sm flex items-center gap-3 relative overflow-hidden opacity-80">
                <div class="w-10 h-10 rounded-full bg-orange-50 text-david-orange flex items-center justify-center text-lg shrink-0">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 text-sm">真人客服</h4>
                    <p class="text-[10px] text-gray-500">專人服務</p>
                </div>
                <i class="fas fa-lock text-gray-300 absolute top-2 right-2 text-[10px]"></i>
            </div>
        </div>
    </section>

    <!-- 5. Sticky Footer (唯一的行動呼籲) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-orange-100 p-4 pb-safe z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <button id="ctaBtn" class="w-full bg-[#06C755] hover:bg-[#05b64d] text-white font-bold py-3.5 rounded-xl text-lg shadow-lg shadow-green-200 active:scale-[0.98] transition-transform flex items-center justify-center gap-2 group relative overflow-hidden">

            <!-- 光澤動畫 -->
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full animate-[shimmer_2s_infinite]"></div>

            <i class="fab fa-line text-2xl"></i>
            <div class="text-left leading-none ml-1">
                <span class="block text-[10px] opacity-80 font-normal">David 鐵板燒</span>
                <span id="ctaBtnText" class="block text-base tracking-wide">加入好友．領取 $200</span>
            </div>
            <i class="fas fa-chevron-right text-xs opacity-70 ml-2 group-hover:translate-x-1 transition-transform"></i>
        </button>
    </div>

    <style>
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
    </style>

    <script>
        // ====== 設定區 ======
        const CONFIG = {
            LIFF_ID: '2008632026-9EqRbegz',
            LINE_OA_ID: '@662sordy',
            N8N_WEBHOOK: 'https://tk2line.zeabur.app/webhook/liff-tracking',
            CONTENT_ID: 'david_teppanyaki'
        };

        // ====== Variables ======
        let cachedIP = null;

        // 一般日誌
        function log(message) {
            console.log(message);
        }

        // ====== Session Management ======
        const STORAGE_KEY = 'liff_session_id';
        const TTCLID_KEY = 'liff_ttclid';
        let SESSION_ID = sessionStorage.getItem(STORAGE_KEY);
        let storedTtclid = sessionStorage.getItem(TTCLID_KEY);

        // Check if session_id is passed in URL (redirect from external)
        const currentParams = new URLSearchParams(window.location.search);
        const externalSessionId = currentParams.get('session_id');
        const currentTtclid = currentParams.get('ttclid');

        if (externalSessionId) {
            // Continuation of session (External -> Internal)
            SESSION_ID = externalSessionId;
            log(`[Session] Continuing session from URL: ${SESSION_ID}`);
            sessionStorage.setItem(STORAGE_KEY, SESSION_ID);
        } else if (currentTtclid) {
            // New Ad Entry -> FORCE NEW Session
            log(`[Session] New ttclid detected (${currentTtclid}) -> Generating NEW Session ID`);
            SESSION_ID = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 5);
            sessionStorage.setItem(STORAGE_KEY, SESSION_ID);
            sessionStorage.setItem(TTCLID_KEY, currentTtclid);
        } else {
            // No ttclid & No external session_id -> Keep existing session (if any)
            if (SESSION_ID) {
                log(`[Session] Using existing ID: ${SESSION_ID}`);
            } else {
                // Generate new session for direct visits
                SESSION_ID = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 5);
                sessionStorage.setItem(STORAGE_KEY, SESSION_ID);
                log(`[Session] Generated new ID: ${SESSION_ID}`);
            }
        }

        log(`[Session] Current ID: ${SESSION_ID}`);

        // 獲取 IP 地址
        async function getIPAddress() {
            if (cachedIP) return cachedIP;
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                cachedIP = data.ip;
                log(`[IP] Got: ${cachedIP}`);
                return cachedIP;
            } catch (error) {
                log(`[IP] Error: ${error.message}`);
                return null;
            }
        }

        // 取得 URL 參數
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                ttclid: params.get('ttclid') || '',
                campaign: params.get('campaign') || '',
                adgroup: params.get('adgroup') || '',
                ad: params.get('ad') || '',
                session_id: params.get('session_id') || '',
                ip: params.get('ip') || ''
            };
        }

        // 發送事件到 n8n
        async function trackEvent(eventName, userId, customSessionId = null) {
            const params = getUrlParams();
            const ip = await getIPAddress();

            const payload = {
                event: eventName,
                userId: userId,
                ip: ip,
                ttclid: params.ttclid,
                sessionId: customSessionId || SESSION_ID,
                campaign: params.campaign,
                adgroup: params.adgroup,
                ad: params.ad,
                contentId: CONFIG.CONTENT_ID,
                contentType: 'product',
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };

            log(`[Track] Sending ${eventName}`);

            try {
                const response = await fetch(CONFIG.N8N_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    log(`[Track] Success`);
                } else {
                    log(`[Track] Failed: ${response.status}`);
                }
            } catch (error) {
                log(`[Track] Error: ${error.message}`);
            }
        }

        // 發送 LinkUser 事件（用於更新 anonymous 記錄）
        async function trackLinkUser(userId, sessionId, ip) {
            const params = getUrlParams();

            const payload = {
                event: 'LinkUser',
                userId: userId,
                sessionId: sessionId,
                ip: ip,
                ttclid: params.ttclid,
                campaign: params.campaign,
                contentId: CONFIG.CONTENT_ID,
                timestamp: new Date().toISOString()
            };

            log(`[Track] Sending LinkUser - userId: ${userId}, sessionId: ${sessionId}, ip: ${ip}`);

            try {
                const response = await fetch(CONFIG.N8N_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    log(`[Track] LinkUser Success`);
                } else {
                    log(`[Track] LinkUser Failed: ${response.status}`);
                }
            } catch (error) {
                log(`[Track] LinkUser Error: ${error.message}`);
            }
        }

        // 開啟 LINE 對話
        function openLineChat() {
            const chatUrl = `https://line.me/R/oaMessage/${CONFIG.LINE_OA_ID}/`;
            log(`[LINE] Opening: ${chatUrl}`);

            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.openWindow({ url: chatUrl, external: false });
            } else {
                window.location.href = chatUrl;
            }
        }

        // 開啟 LINE App（帶入 IP 和 session_id）- 優化版：不等待
        function openLineApp() {
            log('[Action] openLineApp called');

            // 使用已快取的 IP（頁面載入時已預取）
            const ip = cachedIP;

            // 保留 URL 參數，加入 IP 和 session_id
            const urlParams = getUrlParams();
            const params = new URLSearchParams();

            if (urlParams.ttclid) params.set('ttclid', urlParams.ttclid);
            if (urlParams.campaign) params.set('campaign', urlParams.campaign);
            if (urlParams.adgroup) params.set('adgroup', urlParams.adgroup);
            if (urlParams.ad) params.set('ad', urlParams.ad);
            params.set('session_id', SESSION_ID);
            if (ip) params.set('ip', ip);

            // 發送 ClickButton 事件（不等待）
            trackEvent('ClickButton', 'anonymous').catch(e => console.error(e));

            // 使用 line:// scheme 開啟 LINE App
            const lineSchemeUrl = `line://app/${CONFIG.LIFF_ID}?${params.toString()}`;
            log(`[Redirect] Trying: ${lineSchemeUrl}`);

            // 立即嘗試開啟
            window.location.href = lineSchemeUrl;

            // 2.5 秒後如果還在頁面，fallback 到 https
            setTimeout(() => {
                const httpsUrl = `https://liff.line.me/${CONFIG.LIFF_ID}?${params.toString()}`;
                log(`[Fallback] Going to: ${httpsUrl}`);
                window.location.href = httpsUrl;
            }, 2500);
        }

        // 初始化 LIFF
        async function initApp() {
            log('[LIFF] Initializing...');
            log(`[Session] ${SESSION_ID}`);

            // 檢查 URL 是否有帶入參數（從外部瀏覽器跳轉過來）
            const urlParams = getUrlParams();
            const existingSessionId = urlParams.session_id;
            const existingIP = urlParams.ip;

            // 如果 URL 帶有 session_id，這代表是跨瀏覽器/跨 App 的延續
            // 我們應該更新本地的 SESSION_ID 以保持一致
            if (existingSessionId && existingSessionId !== SESSION_ID) {
                log(`[Session] Updating from URL: ${existingSessionId}`);
                SESSION_ID = existingSessionId;
                sessionStorage.setItem(STORAGE_KEY, SESSION_ID);
            }

            const isFromExternal = existingSessionId || existingIP;

            if (existingSessionId) log(`[From URL] session_id: ${existingSessionId}`);
            if (existingIP) log(`[From URL] ip: ${existingIP}`);

            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                log('[LIFF] Init OK');
                log(`[LIFF] Client: ${liff.isInClient()}`);
                log(`[LIFF] LoggedIn: ${liff.isLoggedIn()}`);

                if (liff.isLoggedIn()) {
                    // 如果是從外部跳轉過來，發送 Contact + LinkUser 並跳轉
                    if (isFromExternal) {
                        log('[LIFF] From external browser, sending Contact + LinkUser...');

                        // 取得用戶資料
                        const profile = await liff.getProfile();

                        // 從外部跳轉過來時發送 Contact 事件（不是 ViewContent，避免重複）
                        await trackEvent('Contact', profile.userId);

                        // 同時發送 LinkUser 事件來更新資料庫中的 user_id
                        await trackLinkUser(profile.userId, existingSessionId, existingIP);

                        // 跳轉到加入好友/對話頁面
                        openLineChat();
                        return;
                    }

                    // 正常流程（從 LINE 內直接開啟 LIFF）
                    const profile = await liff.getProfile();
                    log(`[User] ${profile.userId}`);

                    // 背景發送追蹤事件
                    trackEvent('ViewContent', profile.userId).catch(e => log(e));

                    // 移除跳轉樣式，顯示頁面
                    document.body.classList.remove('redirecting');

                    // 更新按鈕文字為「開始對話」
                    document.getElementById('ctaBtnText').textContent = '開始對話．領取優惠';
                    return;
                }

                // 未登入狀態 - 顯示頁面
                log('[LIFF] Not logged in, showing landing page');
                document.body.classList.remove('redirecting');
                trackEvent('ViewContent', 'anonymous').catch(e => log(e));

            } catch (error) {
                log(`[LIFF] Error: ${error.message}`);
                document.body.classList.remove('redirecting');
                trackEvent('ViewContent', 'anonymous').catch(e => log(e));
            }
        }

        // 按鈕事件 - CTA 按鈕點擊（優化版：立即跳轉）
        document.getElementById('ctaBtn').addEventListener('click', function () {
            const btn = this;
            const btnText = document.getElementById('ctaBtnText');

            btn.disabled = true;
            btnText.textContent = '跳轉中...';

            // 檢查是否在 LINE 內且已登入
            if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                // 發送 ClickButton 事件（不等待）
                liff.getProfile().then(p => trackEvent('ClickButton', p.userId)).catch(e => log(e));
                // 立即開啟 LINE 對話
                openLineChat();
            } else {
                // 開啟 LINE App（已優化為同步）
                openLineApp();
            }
        });

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function () {
            log('[App] DOM loaded');
            // 預先取得 IP（不阻塞，背景執行）
            getIPAddress();
            // 初始化 LIFF
            initApp();
            // 初始化 Banner 滑動
            initBannerSlider();
        });

        // Banner 滑動控制
        function initBannerSlider() {
            const slider = document.getElementById('bannerSlider');
            if (!slider) return;

            const slides = Array.from(slider.children);
            let currentIndex = 0;
            let startX = 0;
            let isTouching = false;
            let scrollTimeout = null;

            // 取得每張 slide 的寬度（含 gap）
            function getSlideWidth() {
                if (slides.length === 0) return 0;
                const slide = slides[0];
                const gap = 12; // gap-3 = 12px
                return slide.offsetWidth + gap;
            }

            // 滾動到指定 slide
            function goToSlide(index, immediate = false) {
                if (index < 0) index = 0;
                if (index >= slides.length) index = slides.length - 1;
                currentIndex = index;

                const slideWidth = getSlideWidth();
                const containerWidth = slider.offsetWidth;
                const slideActualWidth = slides[0].offsetWidth;

                // 計算置中位置
                let scrollPos = index * slideWidth - (containerWidth - slideActualWidth) / 2;
                scrollPos = Math.max(0, scrollPos);

                if (immediate) {
                    slider.scrollLeft = scrollPos;
                } else {
                    slider.scrollTo({
                        left: scrollPos,
                        behavior: 'smooth'
                    });
                }
            }

            // 根據當前滾動位置計算最接近的 slide
            function getNearestSlideIndex() {
                const slideWidth = getSlideWidth();
                const containerWidth = slider.offsetWidth;
                const slideActualWidth = slides[0].offsetWidth;
                const offset = (containerWidth - slideActualWidth) / 2;

                const scrollPos = slider.scrollLeft + offset;
                return Math.round(scrollPos / slideWidth);
            }

            // Touch 開始
            slider.addEventListener('touchstart', function(e) {
                isTouching = true;
                startX = e.touches[0].clientX;
                // 清除任何待執行的滾動
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = null;
                }
            }, { passive: true });

            // Touch 結束 - 判斷方向並跳轉
            slider.addEventListener('touchend', function(e) {
                isTouching = false;
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                const threshold = 30; // 滑動門檻

                // 延遲一點讓原生滾動完成，然後強制對齊
                scrollTimeout = setTimeout(() => {
                    if (diffX > threshold) {
                        // 向左滑 -> 下一張
                        goToSlide(currentIndex + 1);
                    } else if (diffX < -threshold) {
                        // 向右滑 -> 上一張
                        goToSlide(currentIndex - 1);
                    } else {
                        // 滑動距離不夠，對齊到最近的 slide
                        goToSlide(getNearestSlideIndex());
                    }
                }, 50);
            }, { passive: true });

            // 滾動結束時確保對齊（備用方案）
            let scrollEndTimeout = null;
            slider.addEventListener('scroll', function() {
                if (isTouching) return;

                if (scrollEndTimeout) {
                    clearTimeout(scrollEndTimeout);
                }
                scrollEndTimeout = setTimeout(() => {
                    // 滾動停止後，確保對齊到最近的 slide
                    const nearestIndex = getNearestSlideIndex();
                    if (nearestIndex !== currentIndex) {
                        goToSlide(nearestIndex);
                    }
                }, 150);
            }, { passive: true });
        }
    </script>
</body>
</html>
